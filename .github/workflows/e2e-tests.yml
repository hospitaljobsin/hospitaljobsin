name: E2E Tests
on:
  workflow_call:

env:
  COMPOSE_BAKE: true
  GOOGLE_CLIENT_ID: ${{ secrets.TEST_GOOGLE_OAUTH_CLIENT_ID }}
  GOOGLE_CLIENT_SECRET: ${{ secrets.TEST_GOOGLE_OAUTH_CLIENT_SECRET }}
  SEEKER_PORTAL_UI_SENTRY_DSN: ${{secrets.SEEKER_PORTAL_SENTRY_DSN}}
  RECRUITER_PORTAL_UI_SENTRY_DSN: ${{secrets.RECRUITER_PORTAL_UI_SENTRY_DSN}}
  ACCOUNTS_UI_SENTRY_DSN:  ${{secrets.ACCOUNTS_SENTRY_DSN}}
  SERVER_SENTRY_DSN: ${{secrets.SERVER_SENTRY_DSN}}
  # repo-level and non-env-specific secrets/vars
  AWS_ACCESS_KEY_ID: ${{ secrets.DEPLOYMENT_AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.DEPLOYMENT_AWS_SECRET_ACCESS_KEY }}

concurrency:
  group: e2e-tests-${{ github.ref_name == 'production' && 'production' || 'staging' }}  # Ensures only one run of this workflow at a time
  cancel-in-progress: true

jobs:
  setup-infrastructure:
    environment: staging
    name: Set up Infrastructure
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.start-ec2-runner.outputs.label }}
      ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}
    steps:
      - uses: actions/checkout@v4

      # Configure AWS CLI
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Invoke Staging Setup Lambda
        run: |
            aws lambda invoke \
              --function-name ${{ vars.STAGING_ENVIRONMENT_SETUP_LAMBDA_FUNCTION_ARN }} \
              --payload '{}' \
              --cli-binary-format raw-in-base64-out \
              response.json
      # Scale ECS + ASG up
      - name: Scale up ECS service and ASG
        run: |
          echo "Scaling up ASG..."
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ vars.AWS_ASG_NAME }} \
            --min-size 1 \
            --desired-capacity 1

          echo "Scaling up ECS Backend service..."
          aws ecs update-service \
            --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
            --service ${{ vars.AWS_BACKEND_ECS_SERVICE }} \
            --desired-count 1

          echo "Scaling up ECS Mailcatcher service..."
          aws ecs update-service \
            --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
            --service ${{ vars.AWS_BACKEND_ECS_MAILCATCHER_SERVICE }} \
            --desired-count 1

          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
            --services ${{ vars.AWS_BACKEND_ECS_SERVICE }} ${{ vars.AWS_BACKEND_ECS_MAILCATCHER_SERVICE }}

      - name: Start EC2 runner
        id: start-ec2-runner
        uses: machulav/ec2-github-runner@v2.4.0
        with:
          mode: start
          github-token: ${{ secrets.PA_TOKEN_GITHUB }}
          ec2-image-id: ${{ vars.AWS_PLAYWRIGHT_AMI_ID }}
          ec2-instance-type: ${{ vars.ACTIONS_RUNNER_INSTANCE_TYPE }}
          subnet-id: ${{ vars.ACTIONS_RUNNER_SUBNET_ID }}
          security-group-id: ${{ vars.ACTIONS_RUNNER_SECURITY_GROUP_ID }}
          iam-role-name: ${{ vars.ACTIONS_RUNNER_INSTANCE_PROFILE_NAME }}
          aws-resource-tags: > # optional, requires additional permissions
            [
              {"Key": "Name", "Value": "ec2-github-runner"},
              {"Key": "GitHubRepository", "Value": "${{ github.repository }}"}
            ]
          block-device-mappings: > # optional, to customize EBS volumes
            [
              {"DeviceName": "/dev/sda1", "Ebs": {"VolumeSize": 50, "VolumeType": "gp3"}}
            ]

  test-e2e:
    environment: staging
    name: 'Test on ${{ matrix.project }} (${{ matrix.shard }}/4)'
    needs: setup-infrastructure
    strategy:
      fail-fast: false
      matrix:
        project: [chromium]
        # project: [chromium, firefox, webkit]
        # shard: [1, 2, 3, 4]
    runs-on: ${{ needs.setup-infrastructure.outputs.label }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm --filter e2e install --frozen-lockfile


      - name: Get Mailcatcher ECS task IP address
        id: get-mailcatcher-ip
        run: |
          echo "Getting Mailcatcher ECS task IP address..."

          # Configure AWS CLI for the test environment
          aws configure set aws_access_key_id ${{ env.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws configure set region ${{ vars.AWS_REGION }}

          echo "AWS region: ${{ vars.AWS_REGION }}"
          echo "ECS cluster: ${{ vars.AWS_BACKEND_ECS_CLUSTER }}"
          echo "Mailcatcher service: ${{ vars.AWS_BACKEND_ECS_MAILCATCHER_SERVICE }}"

          # Get the task ARN for the Mailcatcher service
          TASK_ARN=$(aws ecs list-tasks \
            --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
            --service-name ${{ vars.AWS_BACKEND_ECS_MAILCATCHER_SERVICE }} \
            --query 'taskArns[0]' \
            --output text)

          echo "Task ARN: $TASK_ARN"

          if [ "$TASK_ARN" != "None" ] && [ -n "$TASK_ARN" ]; then
            echo "Found Mailcatcher task: $TASK_ARN"

            # Get the task details including network interface
            TASK_DETAILS=$(aws ecs describe-tasks \
              --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
              --tasks $TASK_ARN)

            echo "Task details: $TASK_DETAILS"

            # Extract the private IP address from the task details
            PRIVATE_IP=$(echo "$TASK_DETAILS" | jq -r '.tasks[0].attachments[0].details[] | select(.name=="privateIPv4Address").value')

            echo "Extracted private IP: $PRIVATE_IP"

            if [ "$PRIVATE_IP" != "null" ] && [ -n "$PRIVATE_IP" ]; then
              echo "Mailcatcher private IP: $PRIVATE_IP"
              echo "mailcatcher_ip=$PRIVATE_IP" >> $GITHUB_OUTPUT
            else
              echo "Could not extract private IP from task details"
              echo "Task details: $TASK_DETAILS"
              exit 1
            fi
          else
            echo "No running Mailcatcher tasks found"
            exit 1
          fi

      - name: Run Playwright tests
        run: pnpm --filter e2e run test --trace=on --project=${{ matrix.project }} --workers=2
        # run: pnpm --filter e2e run test --trace=on --project=${{ matrix.project }} --shard=${{ matrix.shard }}/4 --workers=2
        working-directory: e2e
        env:
          CI: true
          DEBUG: pw:browser
          API_BASE_URL: ${{ vars.SST_API_URL }}
          ACCOUNTS_UI_BASE_URL: ${{ vars.SST_ACCOUNTS_BASE_URL }}
          SEEKER_PORTAL_BASE_URL: ${{ vars.SST_SEEKER_PORTAL_BASE_URL }}
          MAILCATCHER_BASE_URL: "http://${{ steps.get-mailcatcher-ip.outputs.mailcatcher_ip }}:1080"
          ENVIRONMENT: staging
          BASIC_AUTH_USERNAME: ${{ secrets.BASIC_AUTH_USERNAME }}
          BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
          # PLAYWRIGHT_SHARD: ${{ matrix.shard }}
          PLAYWRIGHT_BROWSERS_PATH: /usr/local/share/pw-browsers

      - name: Upload Playwright Report and Traces
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.project }}
          # name: playwright-report-${{ matrix.project }}-${{ matrix.shard }}
          path: |
            e2e/playwright-report/
            e2e/test-results/**/*.zip
          retention-days: 30

  cleanup-infrastructure:
    environment: staging
    name: Cleanup Infrastructure
    needs:
      - test-e2e
      - setup-infrastructure
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      # Configure AWS CLI
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Stop EC2 runner
        uses: machulav/ec2-github-runner@v2.4.0
        with:
          mode: stop
          github-token: ${{ secrets.PA_TOKEN_GITHUB }}
          label: ${{ needs.setup-infrastructure.outputs.label }}
          ec2-instance-id: ${{ needs.setup-infrastructure.outputs.ec2-instance-id }}

      - name: Invoke Staging Teardown Lambda
        run: |
              aws lambda invoke \
                --function-name ${{ vars.STAGING_ENVIRONMENT_TEARDOWN_LAMBDA_FUNCTION_ARN }} \
                --payload '{}' \
                --cli-binary-format raw-in-base64-out \
                response.json

      # Always scale ECS + ASG down after tests
      - name: Scale down ECS service and ASG
        run: |
          echo "Scaling down ECS Backend service..."
          aws ecs update-service \
            --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
            --service ${{ vars.AWS_BACKEND_ECS_SERVICE }} \
            --desired-count 0

          echo "Scaling down ECS Mailcatcher service..."

          aws ecs update-service \
            --cluster ${{ vars.AWS_BACKEND_ECS_CLUSTER }} \
            --service ${{ vars.AWS_BACKEND_ECS_MAILCATCHER_SERVICE }} \
            --desired-count 0

          echo "Scaling down ASG..."
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ vars.AWS_ASG_NAME }} \
            --min-size 0 \
            --desired-capacity 0
